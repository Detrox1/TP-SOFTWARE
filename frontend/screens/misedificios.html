<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../stylesheet/misedificios.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>Mis Edificios</title>
</head>
<body style="background-color: #212121;">
    <header class="header">
        <nav class="nav">
            <div class="perfil" id="perfil-menu">
                <img id="imagen" alt="perfil">
                <div class="menu" id="menu">
                    <ul>
                        <li><a href="index.html">Cerrar sesión</a></li>
                        <li><a href="#" data-toggle="modal" data-target="#editarPerfilModal">Configurar perfil</a></li>
                    </ul>
                </div>
                <p id="nombre"></p>
            </div>    
            <div class="logo">
                <img onclick="menu()" src="../img/home/logo.png" alt="logo">
            </div>
            <div class="info">
                <div class="dinero">
                    <p id="plata"></p>
                </div>
                <div class="material">
                    <p id="cantMaterial">0</p>
                    <img src="../img/home/material.png" alt="logo_material">
                </div>
            </div>
        </nav>
    </header>
    <h1><i class="fa-solid fa-city"></i>Mis edificios<i class="fa-regular fa-building"></i></h1>
    <ul class="edificios-lista">
        <li class="edificio-item">
            <h2><mark>Casas:</mark></h2>
            <div id="casas" class="container"></div>
        </li>
        <li class="edificio-item2">
            <h2><mark>Locales comerciales:</mark></h2>
            <div id="shoppings" class="container"></div>
        </li>
        <li class="edificio-item3">
            <h2><mark>Plazas:</mark></h2>
            <div id="parques" class="container"></div>
        </li>
    </ul>
    <script src="../JS/homescripts.js"></script>

    <!-- Modal -->
    <div class="modal fade" id="editarPerfilModal" tabindex="-1" role="dialog" aria-labelledby="editarPerfilModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="editarPerfilModalLabel">Editar Perfil</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body bg-dark text-white">
                    <!-- Formulario para editar perfil -->
                    <form id="formularioPerfil" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label for="nombre" class="text-white">Nombre</label>
                            <input type="text" class="form-control" id="nombreInput" name="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="imagen" class="text-white">Imagen (URL)</label>
                            <input type="text" class="form-control" id="imagenInput" name="imagen">
                        </div>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Incluir JavaScript de Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", cargarPagina);

        function cargarPagina(event) {
            event.preventDefault();
            const valores = window.location.search;
            const urlParams = new URLSearchParams(valores);
            var id = urlParams.get('id');
            
            fetch(`http://127.0.0.1:5000/selectById?id=${id}`)
                .then(response_received)
                .then(parse_data)
                .catch(request_error);
            
            fetch(`http://127.0.0.1:5000/selectMisEdificios?id=${id}`)
                .then(response_received)
                .then(selectMisEdificios)
                .catch(request_error);
        }        

        function request_error(error) {
            console.log(error);
        }

        function response_received(response) {
            return response.json();
        }

        function parse_data(content) {
            document.getElementById('nombre').textContent = `Nombre: ${content.nombre}`;
            const imagen = document.getElementById("imagen");
            imagen.setAttribute("src", content.imagen);
            document.getElementById('plata').textContent = `Plata: ${content.plata}`;
        }

        function selectMisEdificios(edificios) {
            const casasContainer = document.getElementById('casas');
            const parquesContainer = document.getElementById('parques');
            const shoppingsContainer = document.getElementById('shoppings');

            edificios.forEach(edificio => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${edificio.imagen}" alt="${edificio.nombre}" style="width: 150px; height: 150px;">
                    <h3>${edificio.nombre}</h3>
                    <p>Población: ${edificio.poblacion}</p>
                `;
                
                
                card.innerHTML += `
                    <button onclick="editarEdificio(${edificio.id})">Editar</button>
                    <button onclick="demolerEdificio(${edificio.id})">Demoler</button>
                `;

                if (edificio.clase === 'C') {
                    casasContainer.appendChild(card);
                } else if (edificio.clase === 'P') {
                    parquesContainer.appendChild(card);
                } else if (edificio.clase === 'S') {
                    card.innerHTML += `
                    <p>Tiempo de Recaudación: <span class="timer" id="Tiempo-${edificio.id}">${edificio.tiemporecaudacion}</span></p>
                    <p>Plata de Recaudación: ${edificio.platarecaudacion}</p>
                    <button onclick="recaudar(${edificio.id})">Recaudar</button>
                     `;
                    shoppingsContainer.appendChild(card);
                    empezarRecaudacion(edificio.id, edificio.tiemporecaudacion);
                }
            
            });
        }

        function updateProfile(event) {
            event.preventDefault();
            const valores = window.location.search;
            const urlParams = new URLSearchParams(valores);
            var id = urlParams.get('id');

            const nombre = document.getElementById('nombreInput').value;
            const imagen = document.getElementById('imagenInput').value;
            const data = {
                id: id,
                nombre: nombre,
                imagen: imagen
            };

            fetch('http://127.0.0.1:5000/updateProfile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response_received)
            .then(updating)
            .catch(request_error);
        }

        function updating(content) {
            alert(content.message);
            window.location.reload();
        }

        function menu() {
            const valores = window.location.search;
            const urlParams = new URLSearchParams(valores);
            var id = urlParams.get('id');
            window.location.href = `home.html?id=${id}`;
        }

        function editarEdificio(id) {
            console.log('Editar edificio', id);
        }

        function demolerEdificio(id) {
            console.log('Demoler edificio', id);
        }

        function recaudar(idEdificio) {
            const valores = window.location.search;
            const urlParams = new URLSearchParams(valores);
            var idUsuario = urlParams.get('id');

            const timerElement = document.getElementById(`Tiempo-${idEdificio}`).value
            // Verifica si el temporizador ha llegado a cero
            if (timerElement <= 0) {
                
            // Aquí puedes realizar la solicitud fetch para recaudar
            fetch(`http://127.0.0.1:5000/recaudar?idUsuario=${idUsuario}&idEdificio=${idEdificio}`,{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
            }})
            .then(response_received)
            .then(recaudado)
            .catch(request_error)
   
            } else {
                alert("Todavía no es tiempo para recaudar");
            }
        }


        function empezarRecaudacion(id, tiempo) {
            const timerElement = document.getElementById(`Tiempo-${id}`);
            timerElement.valueTotal = tiempo;
            let totalTiempo = convertirFecha(tiempo);
            

            //el set interval funciona pasando una funcion como primera parte y luego pasando la cantidad de milisegundos por la cual yo quiero que se ejecute
            const interval = setInterval(() => {
                if (totalTiempo <= 0) {
                    clearInterval(interval);
                    timerElement.innerText = 'Listo para recaudar';
                    timerElement.value = totalTiempo;
                } else {
                    totalTiempo -= 1;
                    timerElement.innerText = totalTiempo;
                    timerElement.value = totalTiempo;
                }
            }, 1000);
        }

        function convertirFecha(time) {
            const parts = time.split(':');
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const seconds = parseInt(parts[2], 10);
            return (hours * 3600) + (minutes * 60) + seconds;
        }
        function recaudado(content) {
            alert(content.message)
            const tiempoRecaudacion = document.getElementById(`Tiempo-${content.idEdificio}`).valueTotal
            empezarRecaudacion(content.idEdificio, tiempoRecaudacion);

        }

    </script>
</body>
</html>
